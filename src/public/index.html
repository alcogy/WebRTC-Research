<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC</title>
</head>
<body>
<button id="btn">Start</button>
<div id="wrap"></div>
<script>
    const btn = document.querySelector("#btn")
    btn.addEventListener("click", async () => {
        btn.disabled = true
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        
        const peer = new RTCPeerConnection()
        
        stream.getTracks().forEach(track => {
            peer.addTrack(track, stream)
        })

        const ws = new WebSocket('ws://localhost:9999')
        ws.onopen = async () => {
            const offer = await peer.createOffer()
            await peer.setLocalDescription(offer)
            ws.send(JSON.stringify(offer))
        }
        ws.onmessage = async (msg) => {
            const data = JSON.parse(msg.data)
            switch (data.type) {
                case 'offer':
                    const sdpOffer = new RTCSessionDescription(data)
                    await peer.setRemoteDescription(sdpOffer)
                    const answer = await peer.createAnswer()
                    await peer.setLocalDescription(answer)
                    ws.send(JSON.stringify(answer))
                break

                case 'answer':
                    createVideoElement() 
                    const sdpAnswer = new RTCSessionDescription(data)
                    await peer.setRemoteDescription(sdpAnswer)
                break

                case 'new-ice-candidate': 
                    try {
                        await peer.addIceCandidate(data.candidate)
                    } catch(e) {
                        console.error('Add Ice Candidate error:', e)
                    }
                break
            }
        }
        
        peer.addEventListener('icecandidate', (e) => {
            if (e.candidate) {
                ws.send(JSON.stringify({ type: 'new-ice-candidate', candidate: e.candidate }))
            }
        })

        peer.addEventListener('icegatheringstatechange', (e) => {
            if (peer.iceGatheringState === 'new') {
                createVideoElement()
            }
        })

        peer.addEventListener('track', (e) => {
            const videos = document.getElementsByTagName('video')
            const video = videos[videos.length - 1]
            const [stream] = e.streams
            video.srcObject = stream
        })

        const createVideoElement = () => {
            const video = document.createElement("video")
            video.srcObject = stream
            video.autoplay = true
            const wrap = document.getElementById("wrap")
            wrap.appendChild(video)
        }

    })
</script>
</body>
</html>